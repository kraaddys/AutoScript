# Лабораторная работа №1: Написание простого скрипта оболочки для автоматизации задач

## Студент

**Славов Константин, группа I2302**  
**Дата выполнения: _12.09.2025_**

## Цель работы

Целью данной лабораторной работы является обучение в создании и выполнении простых скриптов **Shell** для автоматизации рутинных задач в операционной системе **Linux**.

## Задание

Выбрать и автоматизировать одно из заданий, представленных ниже используя скрипт **Shell**.

Для выполнения лабораторной работы было выбрано задание с созданием скрипта **`disk_usage.sh`**.

Чтобы выполнить задание требуется:

- Создать скрипт с названием **`disk_usage.sh`**.
- Скрипт должен принимать два обязательных аргумента: путь к каталогу для мониторинга и максимальный объём, зарезервированный для каталога, в мегабайтах.
- Третий аргумент является необязательным и задаёт пороговое значение использования дискового пространства в процентах (по умолчанию 80%).
- Если использование дискового пространства превышает пороговое значение, скрипт должен отправить уведомление на указанный адрес электронной почты.
- Скрипт должен выводить текущее использование дискового пространства в процентах для указанного каталога в файл **`disk_usage.log`**.
- Скрипт должен проверять, что указанный каталог существует, и выводить соответствующие сообщения об ошибках.

## Ход работы

В ходе работы был создан скрипт, который соответствует всем пунктам задания. Далее будет подробное описание работы, а также некоторые тесты, которые покажут, что скрипт работает так, как необходимо.

Сам скрипт имеет следующий вид:

 ```bash
set -euo pipefail
error(){ echo "Ошибка: $*" >&2; exit 1; }

DIR="${1:-}"
MAX_MB="${2:-}"
THRESHOLD="${3:-80}"

[[ -n "$DIR" ]] || error "не указан каталог. Пример: ./disk_usage.sh /tmp 100 75"
[[ -d "$DIR" ]] || error "каталог не существует: $DIR"

[[ "$MAX_MB" =~ ^[0-9]+$ ]] || error "MAX_MB должно быть целым числом"
(( MAX_MB > 0 )) || error "MAX_MB должно быть > 0"

[[ "$THRESHOLD" =~ ^[0-9]+$ ]] || error "порог должен быть целым числом"
(( THRESHOLD >= 0 && THRESHOLD <= 100 )) || error "порог должен быть 0–100"

# корректно считаем размер в МБ, подавляя ошибки доступа к служебным папкам
set +e
set +o pipefail
USED_MB=$(du -sm "$DIR" 2>/dev/null | awk 'NR==1{print $1}')
set -o pipefail
set -e
[[ -z "${USED_MB:-}" ]] && USED_MB=0

USAGE=$(( USED_MB * 100 / MAX_MB ))

# писать текущий процент использования в файл disk_usage.log
echo "$(date '+%F %T') | DIR=$DIR | USAGE=${USAGE}%" >> disk_usage.log

# Информативный вывод
echo "Каталог: $DIR"
echo "Занято: ${USED_MB} МБ из ${MAX_MB} МБ"
echo "Использование: ${USAGE}% (порог: ${THRESHOLD}%)"
echo "Результат записан в disk_usage.log"

# Отправка уведомления на «указанный» email (если он задан)
if (( USAGE > THRESHOLD )); then
  MSG="Внимание: каталог '$DIR' превысил порог ${THRESHOLD}%. Использование: ${USAGE}% (занято ${USED_MB} МБ из ${MAX_MB} МБ)."
  echo "⚠ $MSG"
  if [[ -n "${DISK_USAGE_EMAIL:-}" ]]; then
    if command -v mail >/dev/null 2>&1; then
      echo "$MSG" | mail -s "disk_usage: превышение порога для $DIR" "$DISK_USAGE_EMAIL" || true
      echo "Уведомление отправлено на $DISK_USAGE_EMAIL"
    else
      echo "Примечание: утилита 'mail' не установлена — письмо не отправлено"
    fi
  fi
fi
```
## Описание скрипта `disk_usage.sh`

Скрипт `disk_usage.sh` используется для контроля использования дискового пространства указанного каталога. Он принимает два обязательных аргумента: путь к каталогу и максимально допустимый объём в мегабайтах. Третий аргумент является необязательным и задаёт пороговое значение в процентах (по умолчанию 80%). При запуске скрипт проверяет правильность аргументов и существование каталога, вычисляет его текущий размер, рассчитывает процент использования и записывает результат в лог-файл `disk_usage.log`. В консоли выводится информация о текущем состоянии, а если использование превышает установленный порог, формируется предупреждение. Дополнительно предусмотрена возможность отправки уведомления на электронную почту, если задана переменная окружения `DISK_USAGE_EMAIL`.

### Основные моменты работы скрипта:
- Проверяет входные данные и существование каталога, выводит ошибки при некорректных параметрах.  
- Вычисляет текущий размер каталога с помощью утилиты `du`, корректно обрабатывая недоступные файлы.  
- Рассчитывает процент использования относительно заданного лимита и сохраняет его в `disk_usage.log`.  
- Отображает информацию о размере каталога, лимите и текущем проценте использования в консоли.  
- При превышении порога выводит предупреждение и отправляет сообщение на email (если указан).  

## Проверки скрипта на работоспособность

Ниже на скриншоте будут представлены некоторые команды, которые были использованы для создания скрипта, присвоения ему новых прав, а также просто тестирования его на исправную работу. 

![image](https://i.imgur.com/sqfwj80.jpeg)

**`nano disk_usage.sh`** - используется для открытия редактора **`nano`** и создания файла со скриптом.

**`chmod +x disk_usage.sh`** - прописывается для того, чтобы файл стал исполняемым.

**`export DISK_USAGE_EMAIL="allinityman@gmail.com"`** - при помощи данной команды предварительно был задан email, на который будут отправляться уведомления. Будет использоваться в случае превышения заданного порога памяти.

**`./disk_usage.sh /tmp 10 50`** - запуск скрипта для папки **`/tmp`**, лимит 10 МБ, порог 50%. Результат: занято 1 МБ → 10%, ниже порога → просто запись в лог.

**`./disk_usage.sh /tmp 1 50`** - данная команда была прописана специально для того, чтобы показать как работает скрипт в случае превышения допустимого заданного порога памяти. В данном случае был произведен запуск с порогом в 1 МБ, таким образом было выведено предупреждение и отправлено письмо на указанную выше почту.

**`cat disk_usage.log`** - команда используется для просмотра содержимого лога с информацией.

## Выводы

В ходе лабораторной работы был разработан скрипт **`disk_usage.sh`**, выполняющий мониторинг использования дискового пространства выбранного каталога. Программа принимает два обязательных аргумента — путь к каталогу и максимальный объём в мегабайтах, а также третий необязательный параметр — пороговое значение в процентах, которое по умолчанию равно 80%. В скрипте реализована проверка корректности аргументов и существования каталога, что позволяет избежать ошибок при запуске. В процессе работы вычисляется текущий размер каталога, рассчитывается процент его использования и результат фиксируется в лог-файле **`disk_usage.log`**, что обеспечивает возможность анализа истории изменений.

При превышении заданного порога скрипт выводит предупреждение в консоль и, при наличии указанного email-адреса, отправляет уведомление пользователю. Тестирование показало, что все предусмотренные сценарии отрабатываются корректно: при нормальном заполнении ведётся только запись в лог, а при превышении лимита формируется предупреждение и выполняется рассылка. Исходя из этого, поставленная цель лабораторной работы была достигнута: создан рабочий инструмент для автоматизации контроля дискового пространства средствами Shell-скриптов.

## Библиография

- [Основы Linux Bash.](https://serverspace.ru/support/help/osnovy-linux-bash-rukovodstvo-po-napisaniyu-skriptov/) - Руководство по написанию скриптов — Serverspace. Подробный материал для начинающих, включая аргументы, проверку каталогов, условия и функции.
- [Bash-скрипты: начало / Хабр.](https://habr.com/ru/companies/ruvds/articles/325522/) - Серия публикаций «Bash-скрипты», часть про параметры, ключи командной строки и основы сценариев.
- [DU на русском — Arch Linux мануал переведённый.](https://man.archlinux.org/man/du.1.ru) - Полное описание команды du, её возможностей и опций.
- [Bash best practices | cheat-sheets (Bash cheat-sheet)](https://bertvv.github.io/cheat-sheets/Bash.html) - сборник практик и примеров как писать надёжные скрипты.
- [Google Shell Style Guide](https://google.github.io/styleguide/shellguide.html) - руководство стиля для shell-скриптов, конвенции и лучшие практики.