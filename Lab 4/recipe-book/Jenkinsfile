pipeline {
  agent { label 'php-agent' }

  stages {
    stage('Install Dependencies') {
      steps {
        echo 'Подготовка проекта...'
        sh '''
          set -e
          if [ -f composer.json ]; then
            php -v
            curl -sS https://getcomposer.org/installer -o composer-setup.php
            php composer-setup.php --install-dir=/usr/local/bin --filename=composer
            composer install --no-interaction --prefer-dist
          else
            echo "composer.json не найден — пропускаем установку"
          fi
        '''
      }
    }
    stage('Test') {
      steps {
        echo 'Запуск тестов...'
        sh '''
          set -e
          if [ -x vendor/bin/phpunit ] || [ -f phpunit.xml ] || [ -f phpunit.xml.dist ]; then
            vendor/bin/phpunit --configuration phpunit.xml || vendor/bin/phpunit
          else
            echo "PHPUnit не найден — добавьте composer.json и phpunit.xml"
            exit 1
          fi
        '''
      }
    }
  }
  post {
    always { echo 'Конвейер завершен.' }
    success { echo 'Все этапы прошли успешно!' }
    failure { echo 'Обнаружены ошибки в конвейере.' }
  }
}